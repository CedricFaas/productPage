<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../static/shop.css">
    <script src="//code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.3/socket.io.js" integrity="sha512-2RDFHqfLZW8IhPRvQYmK9bTLfj/hddxGXQAred2wNZGkrKQkLGj8RCkXfRJPHlDerdHHIzTFaahq4s/P4V6Qig==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript" charset="utf-8">
        let intervals = [];
        let pause = false;
        let productNumbers = [1,2,3,4,5]
        const shuffleArray = array => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                const temp = array[i];
                array[i] = array[j];
                array[j] = temp;
            }
        }
        shuffleArray(productNumbers);
        let productNumIndex = 0;
        let productSet = 1;
        let highlightingTechnique = 0;
        let seconds = 60;
        $(document).ready(function () {
            const socket = io('');
            let timerId;

            socket.on('connect', function() {
                socket.send('Shop page connected!');
                socket.emit('loadProduct')
            });
            socket.on('pause', function () {
                window.location.href = "/pause";
                return false;
            });
            socket.on('decision', function () {
                window.location.href = "/decision";
                return false;
            });
            socket.on('questionaire', function () {
                window.location.href = "/questionaire";
                return false;
            });
            socket.on('nextProduct', function () {
                window.location.href = "/nextProduct";
                return false;
            });

            socket.on('loadProduct', function (message) {
                productSet = message['ProductSet']
                pause = message['Pause']
                highlightingTechnique = message['HighlightingTechnique']
                loadData()
                socket.send('load data');
                let timer = seconds.toString()

                seconds < 10 ? timer = "0"+seconds.toString() : timer = seconds.toString();
                document.getElementById("timer").innerHTML = "0:"+timer;
                timerId = setInterval(function () {
                    seconds = seconds - 1;
                    seconds < 10 ? timer = "0" + seconds.toString() : timer = seconds.toString();
                    document.getElementById("timer").innerHTML = "0:" + timer;
                    if (seconds < 0) {
                        clearInterval(timerId);
                        document.getElementById("timer").innerHTML = "EXPIRED";
                        socket.emit('decision')
                    }
                }, 1000);
            })

            $('#cart').click(function () {
                socket.emit('nextProduct', {'ProductSet': productSet, 'ProductNumber': productNumbers[productNumIndex], 'InTime': seconds});
                clearInterval(timerId)
                return false;
            });
        });


        //detecting arrow key presses
        document.addEventListener('keydown', function(e) {
            var refresh = false;
            switch (e.key) {
                case "ArrowLeft":
                    productNumIndex--;
                    if (productNumIndex < 0){productNumIndex = 4}
                    refresh = true;
                    break;
                case "ArrowRight":
                    productNumIndex = (productNumIndex+1)%5;
                    refresh = true;
                    break;
            }
            if (refresh){
                loadData();
            }

        });

        function loadData() {
            $.getJSON('../static/data.json', function(data) {
                //General Information
                const product = data[productSet.toString()][productNumbers[productNumIndex].toString()];
                let element = document.getElementById("Price");
                resetStyle(element);
                element.innerHTML = product['Info']['Price'];
                highlighting(element,product['Info']['Price'],product)
                element = document.getElementById("Brand");
                resetStyle(element);
                element.innerHTML = product['Info']['Brand'];
                highlighting(element,product['Info']['Brand'],product)
                element = document.getElementById("Name");
                resetStyle(element);
                element.innerHTML = product['Info']['Name'];
                highlighting(element,product['Info']['Name'],product)
                //Picture
                $("#Picture").attr("src", product['Picture']);
                //Details
                const ul = document.getElementById("Details");
                $(ul).empty();
                product['Details'].forEach(function (element) {
                    const li = document.createElement("li");
                    $(document.createTextNode(element)).appendTo(li);
                    highlighting(li,element,product);
                    $(li).appendTo(ul);
                });
                //Ad
                const ads = 70;
                const ad1 = getRandomInteger(1, ads);
                document.getElementById("ad1Name").innerHTML = data['Ads'][ad1.toString()]['Name'];
                document.getElementById("ad1Price").innerHTML = data['Ads'][ad1.toString()]['Price'];
                $("#ad1Picture").attr("src", data['Ads'][ad1.toString()]['Picture']);
                let ad2 = getRandomInteger(1,ads);
                while (ad2 === ad1){
                    ad2 = getRandomInteger(1,ads)
                }
                document.getElementById("ad2Name").innerHTML = data['Ads'][ad2.toString()]['Name'];
                document.getElementById("ad2Price").innerHTML = data['Ads'][ad2.toString()]['Price'];
                $("#ad2Picture").attr("src", data['Ads'][ad2.toString()]['Picture']);
                let ad3 = getRandomInteger(1,ads);
                while (ad3 === ad2 || ad3 === ad1){
                    ad3 = getRandomInteger(1,ads)
                }
                document.getElementById("ad3Name").innerHTML = data['Ads'][ad3.toString()]['Name'];
                document.getElementById("ad3Price").innerHTML = data['Ads'][ad3.toString()]['Price'];
                $("#ad3Picture").attr("src", data['Ads'][ad3.toString()]['Picture']);
                let ad4 = getRandomInteger(1,ads);
                while (ad4 === ad3 || ad4 === ad2 || ad4 === ad1){
                    ad4 = getRandomInteger(1,ads)
                }
                document.getElementById("ad4Name").innerHTML = data['Ads'][ad4.toString()]['Name'];
                document.getElementById("ad4Price").innerHTML = data['Ads'][ad4.toString()]['Price'];
                $("#ad4Picture").attr("src", data['Ads'][ad4.toString()]['Picture']);
            });
        }

        function getRandomInteger(min, max) {
            return Math.floor(Math.random() * (max - min + 1) ) + min;
        }

        function highlighting (element, info, product) {
            if (highlightingTechnique > 0){
                if (product["Important"].includes(info)){
                    if (highlightingTechnique === 1) {
                        element.style.fontSize = "125%";
                    } else if (highlightingTechnique === 2){
                        element.style.color = "red";
                    } else if (highlightingTechnique === 3){
                        const Id = setInterval(function() {element.style.opacity = (element.style.opacity === "1" ? "0.5" : "1");}, 300)
                        intervals.push(Id);
                    }
                }
            }
        }

        function resetStyle (element) {
            element.style.fontSize = "";
            element.style.color = "";
            intervals.forEach(value => clearInterval(value));
            intervals.length = 0;
            element.style.opacity = "";
        }
    </script>
    <title>Lebensmittel-Shop</title>
</head>
<body>
<div class="shopName">
    <div class="Title"> Lebensmittel-Shop </div>
    <div class="Timer" id="timer"></div>
</div>

<div class="row">
    <div class="leftcolumn" >
        <img id = "Picture"/>
        <div class="productTitle">
            <article>
                <div id = "Brand" class="productBrand"></div>
                <div id = "Name" class="productTitle"></div>
            </article>
            <article>
                <div id = "Price"></div>
                <button class="cart-btn" id="cart">In den Einkaufswagen</button>
            </article>
        </div>
        <div class="productDetail">
            Produktbeschreibung
        </div>
        <ul id = "Details">
        </ul>
    </div>

    <div class="rightcolumn">
        <div>
            <article>
                <p id="ad1Name"></p>
                <br>
                <p id="ad1Price"></p>
            </article>
            <img id = "ad1Picture"/>
        </div>
        <div>
            <article>
                <p id="ad2Name"></p>
                <br>
                <p id="ad2Price"></p>
            </article>
            <img id = "ad2Picture"/>
        </div>
        <div>
            <article>
                <p id="ad3Name"></p>
                <br>
                <p id="ad3Price"></p>
            </article>
            <img id = "ad3Picture"/>
        </div>
        <div>
            <article>
                <p id="ad4Name"></p>
                <br>
                <p id="ad4Price"></p>
            </article>
            <img id = "ad4Picture"/>
        </div>
    </div>
</div>
</body>
</html>